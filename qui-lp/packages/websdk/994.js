(this.webpackChunk_stechquick_websdk=this.webpackChunk_stechquick_websdk||[]).push([[994],{77059(e,t,i){"use strict";i.d(t,{e:()=>r,u:()=>n});let s=!1;new Promise(e=>e()).then(()=>s=!0),"undefined"!=typeof doNothing&&doNothing();const o=!0===s;function r(e,t={}){let i,s,r;const n=e=>{r&&clearTimeout(r),r=setTimeout(()=>{s(new Error(`The operation has timed out. timeoutValue  : ${e}`))},e)};let a=!1,h=!1;const c=()=>a||h;return e&&n(e),{startTimer:n,promise:new Promise((e,r)=>{const n=(e=>o&&t.fixSyncResolve?t=>setTimeout(()=>e(t)):e)(e);i=e=>{c()||(a=!0,n(e))},s=e=>{c()||(h=!0,r(e))}}),resolver:i,reject:s,isResolved:()=>a,isRejected:()=>h,isCompleted:c}}function n(e){const t=r();let i=e.length;return e.forEach(async e=>{try{await e}finally{--i<=0&&t.resolver(e)}}),t.promise}},40399(e,t,i){"use strict";i.r(t),i.d(t,{PlateauIAM:()=>p});var s=i(43905),o=i(14182),r=i(55049),n=i(77059);function a(e,t){e.postMessage(t,"*")}const h=["https://","http://"];class c{constructor(){this.refreshTime=6e3,this.updateTime=10,this.initOptions={url:"http://identity-provider.dev.rally.softtech/auth/",realm:"main",clientId:"ui-web-client",onLoad:"login-required",pkceMethod:"S256",identityProvider:"",locale:""},this.authOptions={url:"",active:!1},this.iamPlateau=void 0,this.sessionStorageNamePrefix="",this.getToken=()=>null!=this.iamPlateau?this.iamPlateau.token:void 0,this.getInfo=()=>null!=this.iamPlateau?this.iamPlateau.info:void 0}setOptions({iam:e,iamV2:t}){if(this.settingsIAM={iam:e,iamV2:t},t?.active)this.configureNewOAuthSettings(t);else try{const t=e?.options;if(!t)throw new Error("iam in settings is missing options");if(null!=t.identityProvider)if("object"==typeof t.identityProvider){var i="",s=t.url.split("."),o=2;try{(o=parseInt(t.identityProvider.order))<=0&&(o=2)}catch(e){o=2}if("queryString"===t.identityProvider.type){var n=new URLSearchParams(window.location.search);if(null!=n.get("subdomain")&&(i=n.get("subdomain"),s[o-1]=i,this.initOptions.subdomain=i),null!=n.get("realm"))t.realm=n.get("realm"),t.sessionStorageNamePrefix||(document.cookie="queryParamsRealmIAM="+t.realm+";path=/;");else if(!t.sessionStorageNamePrefix){let e=this.getItemFromCookies("queryParamsRealmIAM");e&&(t.realm=e)}const e=t.localeQueryStringKey||"ui_locales";if(null!=n.get(e))this.initOptions.locale=n.get(e),t.sessionStorageNamePrefix||(document.cookie="queryParamsLocaleIAM="+this.initOptions.locale+";path=/;");else if(this.initOptions.locale=void 0,!t.sessionStorageNamePrefix){let e=this.getItemFromCookies("queryParamsLocaleIAM");e&&(this.initOptions.locale=e)}}else"subdomain"===t.identityProvider.type&&(i=window.location.host.split(".")[0],s[o-1]=i);t.url=s.join(".")}else t.identityProvider.length>1&&(t.url=window.location.protocol+"//"+window.location.host.replace(t.identityProvider,"identity-provider")+"/auth");t.url&&(this.initOptions.url=t.url),t.realm&&(this.initOptions.realm=t.realm),t.clientId&&(this.initOptions.clientId=t.clientId),t.onLoad&&(this.initOptions.onLoad=t.onLoad),t.pkceMethod&&(this.initOptions.pkceMethod=t.pkceMethod),t.identityProvider&&(this.initOptions.identityProvider=t.identityProvider),t.redirectUri&&(this.initOptions.redirectUri=t.redirectUri),t.responseMode&&(this.initOptions.responseMode=t.responseMode),t.preserveTokens&&(this.initOptions.preserveTokens=t.preserveTokens)}catch(e){const t=e.message||"error has no message";r.V.Log({logMessage:"Error on setting IAM options: "+t,logType:r.F.Error})}}getItemFromCookies(e){var t,i,s,o=document.cookie.split(";");for(t=0;t<o.length;t++)if(i=o[t].substr(0,o[t].indexOf("=")),s=o[t].substr(o[t].indexOf("=")+1),(i=i.replace(/^\s+|\s+$/g,""))==e)return unescape(s)}configureNewOAuthSettings(e){this.authOptions.active=e.active;const t=e.idendityProviderURL||"";var i=new URLSearchParams(window.location.search);"identityProvider"===e.subdomainSource?e.subdomainValue&&e.subdomainValue.length>1?this.authOptions.url=window.location.protocol+"//"+window.location.host.replace(e.subdomainValue,"identity-provider")+"/auth":console.error("Subdomain value must not be empty!"):(this.authOptions.subdomain=this.getSubdomain(e,i),this.authOptions.url=this.replaceSubdomain(t,this.authOptions)),this.authOptions.realm=this.getRealm(e,i),this.authOptions.language=this.getLocale(e,i),this.authOptions.clientId=e.clientId,this.authOptions.preserveTokens=e.preserveTokens,this.authOptions.redirectUri=e.redirectUri,this.authOptions.onLoad=e.onLoad,this.authOptions.popup=e.popup,this.authOptions.sessionStorageNamePrefix=e.sessionStorageNamePrefix}getLocale(e,t){if(e.isLangFromQS){const i=e.language&&""!=e.language.trim()?e.language:"lang";if(null!=t.get(i))e.language=t.get(i),e.sessionStorageNamePrefix||(document.cookie="queryParamsLocaleIAM="+e.language+";path=/;");else if(!e.sessionStorageNamePrefix){let t=this.getItemFromCookies("queryParamsLocaleIAM");t&&(e.language=t)}}return e.language}replaceSubdomain(e,t){const i=e.split(".");return i[1]=t.subdomain||i[1],i.join(".")}getRealm(e,t){if(e.isRealmFromQS)if(null!=t.get("realm"))e.realm=t.get("realm"),e.sessionStorageNamePrefix||(document.cookie="queryParamsRealmIAM="+e.realm+";path=/;");else if(!e.sessionStorageNamePrefix){let t=this.getItemFromCookies("queryParamsRealmIAM");t&&(e.realm=t)}return e.realm}getSubdomain(e,t){let i="";switch(e.subdomainSource){case"constant":i=e.subdomainValue;break;case"query":i=t.get("subdomain");break;case"currentDomain":i=window.location.host.split(".")[0]}return i}isAuthenticated(){if(null!=this.iamPlateau?.token)return!0}async init(e,t){const i=this.authOptions.active?this.authOptions:this.initOptions;this.sessionStorageNamePrefix=this.settingsIAM?.iam?.options?.sessionStorageNamePrefix||this.authOptions.sessionStorageNamePrefix?`${this.settingsIAM?.iam?.options?.sessionStorageNamePrefix||this.authOptions.sessionStorageNamePrefix}_`:"",this.keycloak=(0,s.A)(i);const o=this.getTokens();let r=this.getKeyCloakOptions(),n=this.getLoginOptions();o&&o.idToken&&o.refreshToken&&o.token&&(r.idToken=o.idToken,r.refreshToken=o.refreshToken,r.token=o.token);const a=this.authOptions.active?this.authOptions.redirectUri:this.initOptions.redirectUri;let h=this.setQueryOrFragment(new URL(window.location.href),a);h&&(n.redirectUri=h,r.redirectUri=h);let c=!1;if((t?.iamWithPopup??(this.settingsIAM?.iam?.popup||this.authOptions.popup))&&!t?.iamInPopup)c=await this.handleIAMPopup(t,r,this.keycloak);else if(c=await this.keycloak.init(r),!c)return void await this.keycloak.login(n);t?.iamInPopup?this.handleInPopup():(this.setTokens(),"boolean"==typeof c&&(c?this.constructIAMPlateau():window.location.reload(),e()))}async handleIAMPopup(e,t,i){let s;const r=(0,n.e)(),h=async t=>{if(t.source==c)switch(t.data.type){case"setTokens":return window.removeEventListener("message",h),"setTokens"==t.data.type&&r.resolver(t.data.tokenInfo),void clearInterval(s);case"iamReady":const i=(e=>{const t={};for(const i in e)if(e.hasOwnProperty(i)){const s=e[i];"string"!=typeof s&&"number"!=typeof s&&"boolean"!=typeof s&&null!==s||(t[i]=s)}return t})(window);return void a(c,{type:"iamOptions",options:e,tokens:this.getTokens(),sessionStorageNamePrefix:this.sessionStorageNamePrefix,parentWindow:i})}};window.addEventListener("message",h);const c=window.open(o.V.concatUrl(o.V.getScriptRoot(),"../assets/oidc.html"),"plateauIAMPopup","popup");if(!c){const e="Failed to open new window.";throw console.error(e),e}s=setInterval(()=>{if(c.closed){clearInterval(s);const e="popup window closed before authentication";console.error(e),r.reject(new Error(e))}},500);const u=await r.promise;return this.setToOptions(t,u),i.init(t)}handleInPopup(){const e=this.getTokenFromKeycloak();if(!e)throw new Error("could not retrieve tokenInfo from keycloak");a(opener,{type:"setTokens",tokenInfo:e}),window.close()}pathJoin(e,t){return(e=e.endsWith("/")?e.substring(0,e.length-1):e)+"/"+(t.startsWith("/")?t.substring(1):t)}setQueryOrFragment(e,t){if(!t)return;if(null!=h.find(e=>t.startsWith(e)))return t;const i=new URL("http://a.com/"+t),s="/"==e.pathname?"":e.pathname,o="/"==i.pathname?"":i.pathname;let r=s&&o?o.startsWith("//")?o.substring(1):this.pathJoin(s,o):s||o,n=e.search&&i.search?e.search+i.search.replace("?","&"):e.search||i.search,a=e.hash&&i.hash?e.hash+i.hash.replace("#","&"):e.hash||i.hash;return e.origin+r+n+a}constructIAMPlateau(){null==this.iamPlateau?this.iamPlateau={token:this.keycloak?.token,info:this.keycloak?.tokenParsed}:this.iamPlateau.token=this.keycloak?.token,window.location.search&&(document.cookie="queryParamsIAM="+window.location.search+";path=/;")}getTokens(){if(this.authOptions.preserveTokens||this.settingsIAM?.iam?.options?.preserveTokens)return{idToken:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcIdToken")??void 0,refreshToken:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcRefreshToken")??void 0,token:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcToken")??void 0}}getTokenFromKeycloak(){if(this.keycloak&&this.keycloak.idToken&&this.keycloak.refreshToken&&this.keycloak.token)return{idToken:this.keycloak.idToken,refreshToken:this.keycloak.refreshToken,token:this.keycloak.token,info:this.keycloak.tokenParsed}}setToOptions(e,t){e.idToken=t.idToken,e.refreshToken=t.refreshToken,e.token=t.token}setTokens(e={}){if(!this.authOptions.preserveTokens&&!this.settingsIAM?.iam?.options?.preserveTokens)return;const t=e.tokenInfo??this.getTokenFromKeycloak();t&&(sessionStorage.setItem(this.sessionStorageNamePrefix+"kcIdToken",t.idToken),sessionStorage.setItem(this.sessionStorageNamePrefix+"kcRefreshToken",t.refreshToken),sessionStorage.setItem(this.sessionStorageNamePrefix+"kcToken",t.token))}async refreshPromise(){let e=!1;try{e=await(this.keycloak?.updateToken(this.updateTime)),this.constructIAMPlateau(),this.setTokens()}catch(e){window.location.href=window.location.protocol+"//"+window.location.host}return e}getKeyCloakOptions(){return this.authOptions.active?{onLoad:"login-required",pkceMethod:"S256",checkLoginIframe:!1,responseMode:"fragment"}:{onLoad:this.initOptions.onLoad,pkceMethod:this.initOptions.pkceMethod,checkLoginIframe:!1,responseMode:this.initOptions.responseMode}}getLoginOptions(){return{locale:this.authOptions.language||this.initOptions.locale}}logout(){let e=window.location.protocol+"//"+window.location.host,t=this.getLogoutURLParams();e=this.getRedirectURL(t,e),r.V.Log({logMessage:"getredirectURL:"}),r.V.Log({logMessage:e});const i={redirectUri:e},s=this.keycloak?.createLogoutUrl(i),o={redirectUri:s};this.keycloak?.logout(o)}getRedirectURL(e,t){return(this.authOptions.active||"queryString"===this.initOptions.identityProvider.type)&&e.reduce((e,i,s)=>i.value?t=t+(0===s?"?":"&")+`${i.key}=${i.value}`:e,""),t}getLogoutURLParams(){const e=this.authOptions.active?this.authOptions:this.initOptions,t=this.authOptions.active?this.authOptions.language:this.initOptions.locale;return[{key:"realm",value:e.realm},{key:"subdomain",value:e.subdomain},{key:"lang",value:t}]}async login(e){await this.init(()=>{},e)}}var u=i(86359);const l=["https://","http://"];class d{constructor(){this.initOptions={url:"http://identity-provider.dev.rally.softtech/auth/",realm:"main",clientId:"ui-web-client",onLoad:"login-required",pkceMethod:"S256",identityProvider:"",locale:""},this.authOptions={url:"",active:!1},this.sessionStorageNamePrefix="",this.user=null,this.iamPlateau=void 0,this.getToken=()=>this.user?.access_token||sessionStorage.getItem(this.sessionStorageNamePrefix+"kcToken")||void 0,this.getInfo=()=>this.user?.profile||void 0}setOptions({iam:e,iamV2:t}){if(this.settingsIAM={iam:e,iamV2:t},t?.active)this.configureNewOAuthSettings(t);else try{const t=e?.options;if(!t)throw new Error("iam in settings is missing options");if(null!=t.identityProvider)if("object"==typeof t.identityProvider){var i="",s=t.url.split("."),o=2;try{(o=parseInt(t.identityProvider.order))<=0&&(o=2)}catch(e){o=2}if("queryString"===t.identityProvider.type){var n=new URLSearchParams(window.location.search);if(null!=n.get("subdomain")&&(i=n.get("subdomain"),s[o-1]=i,this.initOptions.subdomain=i),null!=n.get("realm"))t.realm=n.get("realm"),t.sessionStorageNamePrefix||(document.cookie="queryParamsRealmIAM="+t.realm+";path=/;");else if(!t.sessionStorageNamePrefix){let e=this.getItemFromCookies("queryParamsRealmIAM");e&&(t.realm=e)}const e=t.localeQueryStringKey||"ui_locales";if(null!=n.get(e))this.initOptions.locale=n.get(e),t.sessionStorageNamePrefix||(document.cookie="queryParamsLocaleIAM="+this.initOptions.locale+";path=/;");else if(this.initOptions.locale=void 0,!t.sessionStorageNamePrefix){let e=this.getItemFromCookies("queryParamsLocaleIAM");e&&(this.initOptions.locale=e)}t.url=s.join(".")}else"subdomain"===t.identityProvider.type&&(i=window.location.host.split(".")[0],s[o-1]=i,t.url=s.join("."))}else t.identityProvider.length>1&&(t.url=this.normalizeAuthBaseUrl(t.url));t.url&&(this.initOptions.url=this.normalizeAuthBaseUrl(t.url)),t.realm&&(this.initOptions.realm=t.realm),t.clientId&&(this.initOptions.clientId=t.clientId),t.onLoad&&(this.initOptions.onLoad=t.onLoad),t.pkceMethod&&(this.initOptions.pkceMethod=t.pkceMethod),t.identityProvider&&(this.initOptions.identityProvider=t.identityProvider),t.redirectUri&&(this.initOptions.redirectUri=t.redirectUri),t.responseMode&&(this.initOptions.responseMode=t.responseMode),t.preserveTokens&&(this.initOptions.preserveTokens=t.preserveTokens),t.useStaticOidcMetadata&&(this.initOptions.useStaticOidcMetadata=t.useStaticOidcMetadata)}catch(e){const t=e.message||"error has no message";r.V.Log({logMessage:"Error on setting IAM options: "+t,logType:r.F.Error})}}getItemFromCookies(e){var t,i,s,o=document.cookie.split(";");for(t=0;t<o.length;t++)if(i=o[t].substr(0,o[t].indexOf("=")),s=o[t].substr(o[t].indexOf("=")+1),(i=i.replace(/^\s+|\s+$/g,""))==e)return unescape(s)}configureNewOAuthSettings(e){this.authOptions.active=e.active;const t=e.idendityProviderURL||"",i=new URLSearchParams(window.location.search);"identityProvider"===e.subdomainSource?e.subdomainValue&&e.subdomainValue.length>1?this.authOptions.url=window.location.protocol+"//"+window.location.host.replace(e.subdomainValue,"identity-provider")+"/auth":console.error("Subdomain value must not be empty!"):(this.authOptions.subdomain=this.getSubdomain(e,i),this.authOptions.url=this.replaceSubdomain(t,this.authOptions.subdomain)),this.authOptions.realm=this.getRealm(e,i),this.authOptions.language=this.getLocale(e,i),this.authOptions.clientId=e.clientId,this.authOptions.preserveTokens=e.preserveTokens,this.authOptions.redirectUri=e.redirectUri,this.authOptions.onLoad=e.onLoad,this.authOptions.popup=e.popup,this.authOptions.sessionStorageNamePrefix=e.sessionStorageNamePrefix}getLocale(e,t){if(e.isLangFromQS){const i=e.language?e.language:"lang";if(null!=t.get(i))e.language=t.get(i),e.sessionStorageNamePrefix||(document.cookie="queryParamsLocaleIAM="+e.language+";path=/;");else if(!e.sessionStorageNamePrefix){let t=this.getItemFromCookies("queryParamsLocaleIAM");t&&(e.language=t)}}return e.language}getRealm(e,t){if(e.isRealmFromQS)if(null!=t.get("realm"))e.realm=t.get("realm"),e.sessionStorageNamePrefix||(document.cookie="queryParamsRealmIAM="+e.realm+";path=/;");else if(!e.sessionStorageNamePrefix){let t=this.getItemFromCookies("queryParamsRealmIAM");t&&(e.realm=t)}return e.realm}getSubdomain(e,t){let i="";switch(e.subdomainSource){case"constant":i=e.subdomainValue;break;case"query":i=t.get("subdomain");break;case"currentDomain":i=window.location.host.split(".")[0]}return i}replaceSubdomain(e,t){if(!t)return e;const i=new URL(e),s=i.hostname.split(".");return s.length>2&&(s[0]=t,i.hostname=s.join(".")),i.toString()}normalizeAuthBaseUrl(e){const t=new URL(e),i=t.pathname.replace(/\/+$/,"");return i.endsWith("/auth")?t.pathname=i:t.pathname=`${i}/auth`,t.toString()}isAuthenticated(){return!(!this.user||this.user.expired||!this.user.access_token)||void 0}isAuthCallbackUrl(){const e=new URLSearchParams(window.location.search||""),t=new URLSearchParams((window.location.hash||"").replace(/^#/,"")),i=e.has("code")||t.has("code"),s=e.has("state")||t.has("state");return i&&s}cleanCallbackParams(){const e=new URL(window.location.href),t=e=>{["code","state","session_state","iss"].forEach(t=>e.delete(t))},i=new URLSearchParams(e.search),s=new URLSearchParams(e.hash.replace(/^#/,""));t(i),t(s);const o=e.origin+e.pathname+(i.toString()?`?${i.toString()}`:"")+(s.toString()?`#${s.toString()}`:"");window.history.replaceState({},document.title,o)}toAbsoluteUrl(e){return e?void 0!==l.find(t=>e.startsWith(t))?e:new URL(e,window.location.href).toString():window.location.href}pathJoin(e,t){return(e=e.endsWith("/")?e.substring(0,e.length-1):e)+"/"+(t.startsWith("/")?t.substring(1):t)}setQueryOrFragment(e,t){if(!t)return;if(l.some(e=>t.startsWith(e)))return t;const i=new URL(e),s=new URL("http://a.com/"+t),o="/"===i.pathname?"":i.pathname,r="/"===s.pathname?"":s.pathname,n=o&&r?r.startsWith("//")?r.substring(1):this.pathJoin(o,r):o||r,a=i.search&&s.search?i.search+s.search.replace("?","&"):i.search||s.search,h=i.hash&&s.hash?i.hash+s.hash.replace("#","&"):i.hash||s.hash;return i.origin+n+a+h}readPrefixedTokens(){return{idToken:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcIdToken")??void 0,refreshToken:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcRefreshToken")??void 0,token:sessionStorage.getItem(this.sessionStorageNamePrefix+"kcToken")??void 0}}persistTokens(e){sessionStorage.setItem(this.sessionStorageNamePrefix+"kcIdToken",e.idToken),sessionStorage.setItem(this.sessionStorageNamePrefix+"kcRefreshToken",e.refreshToken),sessionStorage.setItem(this.sessionStorageNamePrefix+"kcToken",e.token)}async storeOidcUserFromTokenInfo(e){if(!this.userManager)return;const t=this.tryReadJwtExp(e.token)??Math.floor(Date.now()/1e3)+300,i=new u.KJ({access_token:e.token,id_token:e.idToken,refresh_token:e.refreshToken,token_type:"Bearer",profile:e.info??{},expires_at:t,scope:"openid profile"});await this.userManager.storeUser(i)}decodeJwtPayload(e){try{const t=e.split(".");if(t.length<2)return;let i=t[1].replace(/-/g,"+").replace(/_/g,"/");const s=i.length%4;return s&&(i+="=".repeat(4-s)),JSON.parse(atob(i))}catch{return}}tryReadJwtExp(e){const t=this.decodeJwtPayload(e);return"number"==typeof t?.exp?t.exp:void 0}async hydrateUserFromPrefixedTokens(){const e=this.readPrefixedTokens();if(!e.token||!e.idToken||!e.refreshToken)return!1;const t=this.tryReadJwtExp(e.token);if(!t)return!1;if(t<=Math.floor(Date.now()/1e3))return!1;const i=this.decodeJwtPayload(e.idToken)??this.decodeJwtPayload(e.token)??{},s=new u.KJ({access_token:e.token,id_token:e.idToken,refresh_token:e.refreshToken,token_type:"Bearer",expires_at:t,profile:i,scope:"openid profile"});return this.userManager?(await this.userManager.storeUser(s),this.user=await this.userManager.getUser()??s):this.user=s,!0}async handleIAMPopup(e){let t;const i=(0,n.e)();let s=null;const r=t=>{if(t.source===s&&t.data&&("iamReady"===t.data.type||"setTokens"===t.data.type))switch(t.data.type){case"setTokens":return void i.resolver(t.data.tokenInfo);case"iamReady":return void a(s,{type:"iamOptions",options:e,tokens:this.readPrefixedTokens(),sessionStorageNamePrefix:this.sessionStorageNamePrefix})}};try{if(window.addEventListener("message",r),s=window.open(o.V.concatUrl(o.V.getScriptRoot(),"../assets/oidc.html"),"plateauIAMPopup","popup"),!s)throw new Error("Failed to open new window.");t=setInterval(()=>{s&&s.closed&&i.reject(new Error("popup window closed before authentication"))},500);const e=await i.promise;this.persistTokens(e),await this.storeOidcUserFromTokenInfo(e),this.user=await(this.userManager?.getUser())??null,this.constructIAMPlateau(),this.maybePersistTokens()}finally{window.removeEventListener("message",r),t&&clearInterval(t)}}handleInPopup(){if(!window.opener)throw new Error("No window.opener in popup (cannot return tokens to parent).");if(!this.user)throw new Error("No authenticated user in popup");const e=this.user.id_token,t=this.user.access_token,i=this.user.refresh_token;if(!e||!t||!i)throw new Error("Missing token(s) in popup (id/access/refresh)");const s={idToken:e,refreshToken:i,token:t,info:this.user.profile};a(window.opener,{type:"setTokens",tokenInfo:s}),setTimeout(()=>window.close(),25)}async init(e,t){if(this.sessionStorageNamePrefix=this.settingsIAM?.iam?.options?.sessionStorageNamePrefix||this.authOptions.sessionStorageNamePrefix?`${this.settingsIAM?.iam?.options?.sessionStorageNamePrefix||this.authOptions.sessionStorageNamePrefix}_`:"",t?.iamInPopup&&await this.hydrateUserFromPrefixedTokens())return void this.handleInPopup();const i=this.deriveAuthority(this.authOptions.active?this.authOptions.url:this.initOptions.url,(this.authOptions.active?this.authOptions.realm:this.initOptions.realm)||"master"),s=this.authOptions.active?this.authOptions.redirectUri:this.initOptions.redirectUri,n=`${window.location.origin}${window.location.pathname}`,a=this.setQueryOrFragment(n,s)??this.toAbsoluteUrl(s),h=(this.authOptions.active?this.authOptions.clientId:this.initOptions.clientId)??"ui-web-client",c=`${o.V.concatUrl(o.V.getScriptRoot(),"../assets/silentRenew.html")}?p=${encodeURIComponent(this.sessionStorageNamePrefix)}`,l={authority:i,client_id:h,redirect_uri:a,post_logout_redirect_uri:window.location.origin,silent_redirect_uri:c,response_type:"code",scope:"openid profile",loadUserInfo:!1,automaticSilentRenew:!1,userStore:new u.O({store:window.sessionStorage,prefix:this.sessionStorageNamePrefix+"oidc."}),stateStore:new u.O({store:window.sessionStorage,prefix:this.sessionStorageNamePrefix+"oidc."}),extraQueryParams:this.authOptions.language||this.initOptions.locale?{ui_locales:this.authOptions.language||this.initOptions.locale}:void 0};if(!0===this.initOptions.useStaticOidcMetadata&&(l.metadata={issuer:i,authorization_endpoint:`${i}/protocol/openid-connect/auth`,token_endpoint:`${i}/protocol/openid-connect/token`,end_session_endpoint:`${i}/protocol/openid-connect/logout`,jwks_uri:`${i}/protocol/openid-connect/certs`}),this.persistOidcRuntimeConfig({authority:i,client_id:h,redirect_uri:l.redirect_uri,silent_redirect_uri:l.silent_redirect_uri,useStaticOidcMetadata:!0===this.initOptions.useStaticOidcMetadata}),this.userManager=new u.$5(l),await this.hydrateUserFromPrefixedTokens(),(t?.iamWithPopup??(this.settingsIAM?.iam?.popup||this.authOptions.popup))&&!t?.iamInPopup){await this.handleIAMPopup(t);try{e()}catch{}return}if(this.isAuthCallbackUrl())try{const i=await this.userManager.signinRedirectCallback();if(document.cookie="iamReturnQjson=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax",this.user=i??await this.userManager.getUser()??null,this.cleanCallbackParams(),this.constructIAMPlateau(),this.maybePersistTokens(),t?.iamInPopup)return void this.handleInPopup();try{e()}catch{}return}catch(e){r.V.Log({logMessage:"signinRedirectCallback failed: "+e.message,logType:r.F.Error})}if(this.user=await this.userManager.getUser()??null,this.user&&!this.user.expired){if(this.constructIAMPlateau(),this.maybePersistTokens(),t?.iamInPopup)return void this.handleInPopup();try{e()}catch{}return}if("check-sso"===((this.authOptions.onLoad||this.initOptions.onLoad)??"login-required"))return;let d=this.getItemFromCookies("iamReturnQjson"),p=a;if(d){const e=d.replace(/\.qjson$/i,""),t=new URL(p);t.searchParams.set("q",e),p=t.toString()}await this.userManager.signinRedirect({state:d?{returnQjson:d}:void 0,redirect_uri:p})}async login(e){return this.init(()=>{},e)}async refreshPromise(e=10){return this.refreshInFlight||(this.refreshInFlight=this.refreshPromiseInternal(e).finally(()=>{this.refreshInFlight=void 0})),this.refreshInFlight}async refreshPromiseInternal(e=10){if(!this.userManager)return!1;if(this.user||(this.user=await this.userManager.getUser()??null,this.user||await this.hydrateUserFromPrefixedTokens(),this.constructIAMPlateau(),this.maybePersistTokens()),!this.user){try{await this.userManager.signinRedirect()}catch{}return!1}const t=this.user.expires_at??this.tryReadJwtExp(this.user.access_token)??0;if(t-Math.floor(Date.now()/1e3)>e)return!this.user.expires_at&&t>0&&(this.user.expires_at=t,await this.userManager.storeUser(this.user)),this.constructIAMPlateau(),this.maybePersistTokens(),!0;try{const e=await this.userManager.signinSilent();return this.user=e??null,this.constructIAMPlateau(),this.maybePersistTokens(),!!e}catch{try{await this.userManager.signinRedirect()}catch{}return!1}}clearPrefixedTokens(){const e=this.sessionStorageNamePrefix;sessionStorage.removeItem(e+"kcToken"),sessionStorage.removeItem(e+"kcRefreshToken"),sessionStorage.removeItem(e+"kcIdToken"),sessionStorage.removeItem(e+"oidc_authority"),sessionStorage.removeItem(e+"oidc_client_id"),sessionStorage.removeItem(e+"oidc_redirect_uri"),sessionStorage.removeItem(e+"oidc_silent_redirect_uri"),sessionStorage.removeItem(e+"oidc_useStaticOidcMetadata")}async logout(){if(!this.userManager)return;const e=this.user??await this.userManager.getUser()??null,t=e?.id_token;this.user=null,this.iamPlateau=void 0,this.clearPrefixedTokens(),await this.userManager.removeUser(),await this.userManager.signoutRedirect({id_token_hint:t,post_logout_redirect_uri:window.location.origin})}deriveAuthority(e,t){const i=e.replace(/\/+$/,"");return i.endsWith("/auth")?`${i}/realms/${t}`:i.endsWith("/auth/")?`${i}realms/${t}`:`${i}/realms/${t}`}constructIAMPlateau(){if(!this.user)return void(this.iamPlateau=void 0);const e=this.user.access_token,t=this.user.profile||void 0;null==this.iamPlateau?this.iamPlateau={token:e,info:t}:this.iamPlateau.token=e,window.location.search&&(document.cookie="queryParamsIAM="+window.location.search+";path=/;")}maybePersistTokens(){if(!this.authOptions.preserveTokens&&!this.settingsIAM?.iam?.options?.preserveTokens)return;if(!this.user)return;const e=this.user.id_token,t=this.user.access_token,i=this.user.refresh_token;e&&sessionStorage.setItem(this.sessionStorageNamePrefix+"kcIdToken",e),i&&sessionStorage.setItem(this.sessionStorageNamePrefix+"kcRefreshToken",i),t&&sessionStorage.setItem(this.sessionStorageNamePrefix+"kcToken",t)}persistOidcRuntimeConfig(e){const t=this.sessionStorageNamePrefix;sessionStorage.setItem(t+"oidc_authority",e.authority),sessionStorage.setItem(t+"oidc_client_id",e.client_id),sessionStorage.setItem(t+"oidc_redirect_uri",e.redirect_uri),sessionStorage.setItem(t+"oidc_silent_redirect_uri",e.silent_redirect_uri),sessionStorage.setItem(t+"oidc_useStaticOidcMetadata",String(e.useStaticOidcMetadata))}}class p{constructor(){this.getToken=()=>this.activeAuthProvider.getToken(),this.getInfo=()=>this.activeAuthProvider.getInfo()}get activeAuthProvider(){if(!this.authProvider){const e=this.authProvider=new c;this.settingsIAM&&e.setOptions({iam:this.settingsIAM.iam,iamV2:this.settingsIAM.iamV2})}return this.authProvider}setOptions({iam:e,iamV2:t}){this.settingsIAM={iam:e,iamV2:t};const i=t?.iamAuth??e?.iamAuth??"keycloak";this.authProvider="oidc-client"===i?new d:new c,this.authProvider.setOptions({iam:e,iamV2:t})}isAuthenticated(){return this.activeAuthProvider.isAuthenticated()}async init(e,t){return this.activeAuthProvider.init(e,t)}async login(e){return this.activeAuthProvider.login(e)}async refreshPromise(){return this.activeAuthProvider.refreshPromise()}logout(){this.activeAuthProvider.logout()}}},25156(){}}]);