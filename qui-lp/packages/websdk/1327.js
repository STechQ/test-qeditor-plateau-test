"use strict";(this.webpackChunk_stechquick_websdk=this.webpackChunk_stechquick_websdk||[]).push([[1327],{51327(e,t,n){n.d(t,{default:()=>l});var s=function(){var e=this.$createElement;return(this._self._c||e)("div")};s._withStripped=!0;var a=n(55049),o=n(74590),r=n(25891),i=n(85628),c=n(44030);const u=r.default.extend({name:"LiveConnection",props:{url:{type:String,default:""},secure:{type:Boolean,default:!1},message:{type:[Object,String],default:""},urlParams:{type:Object,default:()=>{}},enableIamAuth:{type:Boolean,default:!1},sendQueueMessage:{type:Boolean,default:!0},autoConnect:{type:Boolean,default:!1},reconnect:{type:Boolean,default:!1},reconnectInterval:{type:Number,default:60},reconnectBackOff:{type:Boolean,default:!1},_renderingProps:{type:Object,default:{isEditMode:{type:Boolean,default:!1}}}},data(){return this.$props.sendQueueMessage=!1!==this.$props.sendQueueMessage,{typeHelper:new o.B,seqErrCount:0,connection:{readyState:WebSocket.CLOSED,close:()=>{}},urlData:this.$props.url,urlParamsData:this.$props.urlParams,messageData:this.$props.message,messageRequestList:[],timerID:0,reconectTryCount:0,reason:"",onConnectionReason:{connectionError:"ConnectionError",connectionClose:"ConnectionClose",userSend:"UserSend",autoConnect:"AutoConnect"}}},methods:{Send(e,t){let n=this.onConnectionReason.userSend;this.SendMessage(n,e,t)},SendMessage(e,t,n){if(t&&(this.messageData=t),this.messageData){let t="";t=this.typeHelper.isString(this.messageData)?this.messageData:JSON.stringify(this.messageData),this._connect(e,()=>{this.connection.send(t)},n)}else this._connect(e)},Close(){if(this._renderingProps.isEditMode)return;this.connection.close();const e=i.C.settingsWrapper.settings.minEngineLogLevel?a.F[i.C.settingsWrapper.settings.minEngineLogLevel]:void 0;a.V.Log({logMessage:`[ LiveConnection has closed ][Url: ${this.urlData} ] `,minEngineLogLevel:e})},_connect(e,t,n){var s=this;if(!s._renderingProps.isEditMode){switch(this.connection.readyState){case WebSocket.OPEN:return void(t&&t());case WebSocket.CLOSED:this.urlParamsData=n||this.urlParamsData;break;case WebSocket.CLOSING:return;case WebSocket.CONNECTING:return void(t&&this.messageRequestList.push(t))}s._regulateUrl(),s.connection=new WebSocket(s.urlData),s.reason=e,s.connection.onopen=async function(e){if(s.seqErrCount=0,s.enableIamAuth){await(c.WebSDK.getPlateauIAM()?.refreshPromise());var n=c.WebSDK.getPlateauIAM()?.getToken();n&&s.connection.send(JSON.stringify({token:n}))}s.$emit("onConnectionOpen",s.reason),t&&t(),s.sendQueueMessage&&s.messageRequestList&&s.messageRequestList.map(e=>e()),this.reconectTryCount=0},s.connection.onerror=function(e){let t=s.onConnectionReason.connectionError;s.seqErrCount++,s.$emit("onError",e,s.seqErrCount),s.connection.readyState==WebSocket.CLOSED&&1==s.reconnect&&s._reConnect(t)},s.connection.onmessage=async function(e){s.enableIamAuth&&await(c.WebSDK.getPlateauIAM()?.refreshPromise());let t="";t=s.typeHelper.isJsonString(e.data)?JSON.parse(e.data):e.data,s.$emit("onMessageReceived",t)},s.connection.onclose=function(e){let t=s.onConnectionReason.connectionClose;s.$emit("onClose",e),1==s.reconnect&&s._reConnect(t)}}},_regulateUrl(){if(this.urlData=this.url,this.urlData.startsWith("ws")&&null==this.secure)this.urlData;else{this.urlData.startsWith("ws")?this.urlData=this.urlData.split("//")[1]:this.urlData.startsWith("/")&&(this.urlData=this.urlData.substring(1));let e="ws://";this.secure&&(e="wss://"),this.urlData=e.concat(this.urlData)}this._setUrlParams()},_setUrlParams(){for(const e in this.urlParams)this.urlData=this.urlData.replace("#"+e+"#",this.urlParams[e])},_calculateReconnectInterval(e){let t=e;if(this.reconnectBackOff){const n=[1,2,3,5,8,13,21];let s=e/5,a=this.reconectTryCount>n.length?n[n.length-1]:n[this.reconectTryCount-1];t=Math.round(s*a)}return t},_reConnect(e){this.reconectTryCount++;const t=this._calculateReconnectInterval(this.reconnectInterval);this.timerID=window.setTimeout(()=>{delete this.timerID,this.sendQueueMessage||(this.messageData=void 0),this.SendMessage(e)},1e3*t)}},mounted(){if(this.autoConnect){let e=this.onConnectionReason.autoConnect;this._connect(e)}},destroyed(){this.Close()},computed:{message:{get:function(){return this.messageData},set:function(e){this.messageData=e}},urlParams:{get:function(){return this.urlParamsData},set:function(e){this.urlParamsData=e}}}}),l=(0,n(7258).A)(u,s,[],!1,null,null,null).exports}}]);