!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.flowcomponent=t():e.flowcomponent=t()}(this,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};let s;e.r(t),e.d(t,{default:()=>p}),s={getUser:{name:"getUser",type:"flow"},notify:{name:"notify",type:"flow"},userTaskActivity:{name:"userTaskActivity",type:"flow"},preForm:{name:"TaskPreview",type:"qjson"}},s={iPaasEndPoint:{name:"IPaaS_Endpoint",type:"constant"}};const n={"":"Custom","Pending-InProgress":"Pending-InProgress","Pending-Approval":"Pending-Approval","Resolved-Completed":"Resolved-Completed",New:"New",Returned:"Returned","Returned-Originator":"Returned-Originator","Returned-Recipient":"Returned-Recipient","Resolved-Cancelled":"Resolved-Cancelled"},a={"":"StatÃ¼ Yok","Pending-InProgress":"Ä°ÅŸlemde","Pending-Approval":"Bekliyor-Onay","Resolved-Completed":"TamamlandÄ±",New:"Yeni",Returned:"Ä°ade","Returned-Originator":"GiriÅŸÃ§iye Ä°ade Edildi","Returned-Recipient":"Ã‡alÄ±ÅŸana Ä°ade Edildi","Resolved-Cancelled":"Ä°ptal Edildi"};class o{static getDescription(e,t){return("tr_TR"==t?a:n)[e]||e||""}}class r extends Error{static isCustomError(e){return e instanceof r||e.name==r.CustomErrorName}get detail(){return this._detail}constructor(e){super(e.message),this.name=r.CustomErrorName,e.stack&&(this.stack=e.stack),this.type=e.type,this.code=e.code,this.summary=e.summary,this.parameters=e.parameters,this.category=e.category,this._detail=e.detail,this.statusCode=e.statusCode}toJSON(){const e={statusCode:this.statusCode,type:this.type,category:this.category,code:this.code,summary:this.summary,parameters:this.parameters,detail:this.detail,stack:this.stack,message:this.message,additionals:this.additionals};return JSON.stringify(e)}getAdditionalSetter(){return(e,t)=>{this.additionals=this.additionals||{},this.additionals[e]=t}}appendDetail(e){this._detail=this._detail?this._detail+" - "+e:e}}r.CustomErrorName="CustomError_WF_ae24";const i={messages:{startWasNotOnUs:e=>`process ${e} start was not on us. ðŸ˜¢`,wfeWasNotOnUs:({prefix:e,suffix:t})=>`${e?e+" ":""}workflow engine was not on us. ðŸ˜¢${t?" "+t:""}`,workflowEngineWasOnUs:({prefix:e,suffix:t})=>`${e?e+" ":""}workflow engine was on us. ðŸ¤”${t?" "+t:""}`},errors:{di404:(e,t)=>new r({statusCode:404,message:`dataInstance ${t?"history":""} for piid: ${e} can not be found`,category:"error",code:"WFE-235",type:"technical"}),taskId404:e=>new r({statusCode:404,message:`taskId: ${e} can not be found`,category:"error",code:"WFE-232",type:"technical"}),piid404:e=>new r({statusCode:404,message:`piid: ${e} can not be found`,category:"error",code:"WFE-234",type:"technical"}),ctxErr:e=>new Error(`execution context is missing: ${e}`),ctxOnUsErr:e=>new Error(`wfEngineOnUs is missing: ${e}`)},wfeStepNames:{humanTask:"humantask"},calculations:{collectionName:(e,t)=>e+"_"+t,isSystemStep:e=>i.wfeStepNames.humanTask==e}};class d{static formatDate(e,t){"string"==typeof e&&(e=new Date(e));let s={},n="tr-TR";return t.date&&(n=t.date.locale||n,s={...s,year:"numeric",month:"2-digit",day:"2-digit"}),t.time&&(s.hour=s.minute="2-digit",0!=t.time.second&&(s.second="2-digit")),new Intl.DateTimeFormat(n,s).format(e)}static toLocaleIsoString(e){return e=e||new Date,new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString()}static toDefaultTimeStampString(e){if(!e)return;const t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getDate().toString().padStart(2,"0"),a=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0"),r=e.getSeconds().toString().padStart(2,"0"),i=e.getMilliseconds().toString().padStart(3,"0"),d=e.getTimezoneOffset(),c=Math.floor(Math.abs(d)/60),l=Math.abs(d)%60;return`${t}/${s}/${n} ${a}:${o}:${r}:${i}${(d>0?"-":"+")+String(c).padStart(2,"0")+String(l).padStart(2,"0")}`}static fromDefaultTimeStampString(e){if(!e)return;const t=e.match(/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2}):(\d{3})([+-])(\d{2})(\d{2})$/);if(!t)throw new Error("unexpected DefaultTimeStampString format: "+e);const[,s,n,a,o,r,i,d,c,l,u]=t,p=new Date(Date.UTC(parseInt(s),parseInt(n)-1,parseInt(a),parseInt(o),parseInt(r),parseInt(i),parseInt(d))),m=(60*parseInt(l)+parseInt(u))*("+"===c?1:-1);return p.setMinutes(p.getMinutes()-m),p}static toUTCDate(e){return e=e||new Date,new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()))}static async convertHourToLocal(e,t){let s=(e+(-(new Date).getTimezoneOffset()/60-t))%24;return s<0&&(s+=24),s}static toDateInTimezone(e,t){const s=t- -e.getTimezoneOffset()/60;let n=new Date(e.getTime()+60*s*60*1e3);return n.getHours()<0&&n.setHours(n.getHours()+24),n.getHours()>23&&n.setHours(n.getHours()-24),n}}const c={start:"Ä°ÅŸlem BaÅŸlatÄ±ldÄ±",complete:"GÃ¶rev TamamlandÄ±",cancel:"Ä°ptal Edildi",return:"Ä°ade Edildi",finish:"SÃ¼reÃ§ TamamlandÄ±",update:"GÃ¼ncellendi",assignToUser:"KullanÄ±cÄ±ya Atama",assignToUnit:"Birime Atama",assignToSwimlane:"Havuza Atama",save:"Kaydedildi",addNote:"Not Eklendi",updateNote:"Not GÃ¼ncellendi",deleteNote:"Not Silindi",function:"Fonksiyon Ã‡alÄ±ÅŸtÄ±rÄ±ldÄ±",fileUpload:"Dosya YÃ¼klendi",fileDownload:"Dosya Ä°ndirildi",fileDelete:"Dosya Silindi",statusChanged:"Durum DeÄŸiÅŸti",threadRetried:"Tekrar Denendi",terminate:"Process SonlandÄ±rÄ±ldÄ±"},l={start:"Process Started",complete:"Task Completed",cancel:"Cancelled",return:"Rejected",finish:"Process Finished",update:"Updated",assignToUser:"User Assignement",assignToUnit:"Unit Assignment",assignToSwimlane:"Swimlane Assignment",save:"Saved",addNote:"Note Added",updateNote:"Note Updated",deleteNote:"Note Deleted",function:"Function Run",fileUpload:"File Uploaded",fileDownload:"File Downloaded",fileDelete:"File Deleted",statusChanged:"Status Changed",threadRetried:"Retried",terminate:"Process Terminated"};class u{static getDescription(e,t){let s=e||"";return s="tr_TR"===t?Object.keys(c).includes(e)?c[e]:s:Object.keys(l).includes(e)?l[e]:s,s}}const p=async e=>{const t=e.flow.getWFE();if(!t)throw new Error("end step can only be used for workflow flow environment");const s=t.wfExecutionContext(),{wfEngineOnUs:n,workflowModel:a}=s.getWfeOnUs(),{processInstance:r,dataInstance:c,wfInput:l}=s.getWfeOnUsProcessInstance(),{dsManager:p}=s.getScopeStore();if(!p)throw i.errors.ctxErr("dsManager");r.initiatorUser;const{trxQueue:m,lastAction:g,status:f}=n,{processInstanceId:y,businessKey:w}=r,S=Date.now(),h="terminate"==(null==g?void 0:g.actionType)?"terminate":"finish",T=u.getDescription(h,"tr_TR");await t.events.onBeforeProcessEnded(g,h,T),r.instanceStatus="finished",r.status="terminate"==(null==g?void 0:g.actionType)&&f?f:e.props.procesStatus,r.statusDescription=o.getDescription(r.status,"tr_TR"),r.processEnd=d.toDefaultTimeStampString(new Date(S)),r.lastUpdateDescriptionCode=h,r.lastUpdateDescription=T;const I=await async function(e,t,s,n){const a=[];for(const o of e.tasks){const r=await t.Get("WFE_Task",{taskId:o.taskId});if(r){const t={...r,status:"completed",performerUserId:e.initiatorUser.userId,action:s,updatedAt:void 0,endDate:n};a.push(t)}}return a}(r,p,g,S);await p.Delete("WFE_ProcessInst",{processInstanceId:y},{trxQueue:m}),await p.Delete("WFE_Notes",{processInstanceId:y},{trxQueue:m}),await p.Delete("WFE_Files",{processInstanceId:y},{trxQueue:m}),await p.Delete("WFE_Task",{processInstanceId:y},{trxQueue:m});const D=t.converters.convertFromIProcessInstanceHistory(r,c,{wfInput:l,stepStates:void 0});D.systemStatus="terminate"==(null==g?void 0:g.actionType)?"aborted":"completed";const E=t.converters.convertFromINote(r.notes,y,w),v=r.files?t.converters.convertFromIFiles(r.files,y,w):void 0;await p.Insert("WFE_ProcessInstHistory",D,{trxQueue:m}),await p.InsertMany("WFE_NotesHistory",E,{trxQueue:m}),await p.InsertMany("WFE_TaskHistory",I,{trxQueue:m}),v&&await p.InsertMany("WFE_FilesHistory",v,{trxQueue:m}),await t.events.processEnded(g,r,c,a.sla),t.system.gracefulEnd(),e.flow.next()};return t})()));