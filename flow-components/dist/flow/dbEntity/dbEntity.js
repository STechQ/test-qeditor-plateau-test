!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.flowcomponent=t():e.flowcomponent=t()}(this,()=>(()=>{"use strict";var __webpack_modules__={45239:(e,t)=>{t.Mc=void 0,t.Mc="dataType"},59232:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>isomorphicCrypto});const isomorphicCrypto="undefined"!=typeof crypto?eval("crypto"):global.crypto=eval("require")("crypto")}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.exports}__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};return(()=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>x});const e="dataType",t=(n={boolean:!0,datetime:!0,number:!0,dataType:!0,string:!0,constant:!0,dataSet:!0,any:!0},Object.keys(n),"context"),r="output",o="vars";var n;function a(e,t,r,o,n){return{processInstanceId:e,taskId:t,dataInstance:r,actionType:o,customType:n}}function i(e){const{workflow:t,client:r,server:o,wfe:n}=e;if(t)return function(e){return{type:"workflow",...e.context()||{action:void 0},constants:e.constantsWId,addActivity:async t=>{await e.addActivity(t)},openProcessbyLock:async t=>await(null==e?void 0:e.wfe.processContext.retrieveContext(t)),complete:async(t,r,o,n,i)=>{const s=a(t,r,o,n,i);return await(null==e?void 0:e.wfe.processContext.complete(s))},commit:async(t,r,o)=>{const n=a(t,r,o);return await(null==e?void 0:e.wfe.processContext.commit(n))},dataSearch:{searchQuery:async t=>await e.wfe.dataSearch.searchQuery(t)},file:{upload:async(t,r,o,n)=>await e.wfe.file.upload(t,r,o,n),delete:async(t,r)=>{await e.wfe.file.delete(t,r)}}}}(t);if(r)return{type:"client"};if(o)return{type:"server"};if(n){const e=n.wfExecutionContext(),{wfEngineOnUs:t,user:r}=e.getWfeOnUs(),{processInstance:o,dataInstance:a,lastAction:i}=t;return{type:"workflowEngine",processInstance:o,dataInstance:a,action:i,currentUser:r}}throw new Error("WTF: where are you executing this flow ???")}function s(e,t){switch(e){case"'":case'"':return[e,t+1];default:return[void 0,t]}}function c(e,t){if(null!=e)return e[t]}function l(e,t){let r=t;const o=e.length;let n,a="",i=!1;for(var l=0;l<o;l++){let t=e[l];if(i)n==t||"]"==t&&!n?(n&&l++,r=c(r,a),a="",i=!1):a+=t;else switch(t){case".":a&&(r=c(r,a)),a="";break;case"[":a&&(r=c(r,a)),a="",[n,l]=s(e[l+1],l),i=!0;break;default:a+=t}}return a&&(r=c(r,a)),r}const u=function(e){return e.client?"client":e.server?"server":e.wfe?"wfe":"workflow"},p=function(e,n,a){switch(null==e?void 0:e.type){case"boolean":return"true"==e.value;case"input":return l(e.value,n.input);case t:if(a.wfe)return l(e.value,a.wfe.wffContext());if(a.workflow)return l(e.value,a.workflow.context());throw new Error("can not retrieve from Context in "+u(a)+". You can only retrieve Context in workflow.");case o:return l(e.value,n.vars);case r:return l(e.value,n.output);case"constant":if(a.wfe){const t=a.wfe.getConstant(e.value);if(t instanceof Promise)throw new Error("can not retrieve from Constants with async getConstant in "+u(a));return l(e.value,t)}if(a.workflow)return l(e.value,a.workflow.constantsWId);throw new Error("can not retrieve from Constants in "+u(a)+". You can only retrieve Constants in workflow.");case"number":return Number(e.value);case"string":return e.value;case"literal":return function(e,t,r){if(""==e)return"";const o=Object.create(null),{input:n,vars:a,output:s}=t,c={input:n,vars:a,output:s,context:i(r)},l=new Function("window","global","globalThis","flow","document","XMLHttpRequest","fetch","setInterval","navigator",`return \`${e}\`;`).apply(o,[o,o,o,c,void 0,void 0,void 0,void 0,void 0]);return"null"===l?null:l}(e.value,n,a);case"notSet":return;case"enum":return e.value}};var f=__webpack_require__(59232);const d=Date.now()-performance.now();class w{static createFastUID(){return Date.now().toString(36).substring(0,9)+Math.random().toString(36).substring(2,13)}static createSecureUID(){const e=(performance.now()+d).toString(36).replace(".","");let t="";const r=f.a.getRandomValues(new Uint8Array(6));for(let e=0;e<6;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[r[e]%62];return e+t}static createUUID(){return f.a.randomUUID()}}var m=__webpack_require__(45239);class _{constructor(){}decideRuntimePlatform(e){var t,r,o,n;const a=null===(r=(t=e.flow).getWorkflow)||void 0===r?void 0:r.call(t),i=null===(n=(o=e.flow).getServer)||void 0===n?void 0:n.call(o);if(a)return{platformName:"workflow",platformInstance:a};if(i)return{platformName:"server",platformInstance:i};throw new Error("DB Entity step: Unable to determine runtime platform. Neither workflow nor server detected.")}resolveRuntime(e){const{platformName:t,platformInstance:r}=this.decideRuntimePlatform(e),o="workflow"===t?{workflow:r}:{server:r};return{platformName:t,platformInstance:r,environment:o,targetRuntimePlatfrom:"workflow"===t?o.workflow:o.server}}}class g extends Error{static isWrappedFlowError(e){return e instanceof g||e.name==g.name}constructor(e){super(e.message),this.orig_error=e,this.name=g.WrappedFlowErrorName}}g.WrappedFlowErrorName="WrappedFlowError_ae24";class y extends Error{get detail(){return this._detail}constructor(e){super(e.message),this.name=y.FlowErrorName,e.stack&&(this.stack=e.stack),this.type=e.type,this.code=e.code,this.summary=e.summary,this.parameters=e.parameters,this.category=e.category,this._detail=e.detail}static isFlowError(e){return e instanceof y||e.name==y.FlowErrorName}appendDetail(e){this._detail=this._detail?this._detail+" - "+e:e}}function v(e,t){switch(e){case"'":case'"':return[e,t+1];default:return[void 0,t]}}function b(e,t,r){if("other"==r.type){if("object"!=typeof e)return;return e[t]=r.value}let o=e[t];return void 0!==o?o:e[t]="array"==r.type?[]:{}}function h(e,t){switch(e[t]){case'"':case"'":return"object";default:return"array"}}function k(e,t,r){let o=e;const n=t.length;let a,i="",s=!1;for(var c=0;c<n;c++){let e=t[c];if(s)if(a==e||"]"==e&&!a){let e;switch(a&&c++,t[c+1]){case"[":e={type:h(t,c+2)};break;case".":e={type:"object"};break;case void 0:e={type:"other",value:r};break;default:throw new Error("unexpected set msg")}o=b(o,i,e),i="",s=!1}else i+=e;else switch(e){case".":i&&(o=b(o,i,{type:"object"})),i="";break;case"[":i&&(o=b(o,i,{type:h(t,c+1)})),i="",[a,c]=v(t[c+1],c),s=!0;break;default:i+=e}}return i&&(o=b(o,i,{type:"other",value:r})),o}y.FlowErrorName="FlowRuntimeError_ae24";class E{static async mapInnerMsg({environment:e,innerMsg:t,inParamMapping:r,outerMsg:o,store:n},a){t.input=E.mapInput(n.input,r,o,e),n.output=n.output||{},t.output=E.initItems(n.output,t,e),null==a||a.log({level:"log",logCode:"STORE-00",message:"Inner store created"})}static mapInput(e,t,r,o){var n;let a={};return null===(n=Object.entries(e))||void 0===n||n.some(([n,i])=>{let s=t.find(e=>e.variable.value===n);if(s)a[n]=p(s.mapping,r,o);else{const t=e[n].default;if(!t)throw new Error(`input mapping error.'${n}' not found in given mapping.`);a[n]=p(t,r,o)}}),a}static initItems(t,r,o){let n={};const a=["string","number","datetime",e,"boolean"];return Object.entries(t).forEach(([t,i])=>{n[i.name]=!i.default||a.some(e=>{var t;return e==(null===(t=null==i?void 0:i.default)||void 0===t?void 0:t.type)})&&i.default.type!=i.type?i.list?[]:i.type==e?{}:void 0:p(i.default,r,o)}),n}static mapOutput(e,n,a,i){e&&n.forEach(n=>{if(!Object.keys(e).some(e=>e==n.variable.value))throw new Error(`output mapping error.'${n.variable}' not found in function return value. `);!function(e,n,a,i){switch(e.type){case t:if(!e.value)break;if(!i.workflow)throw new Error("can not set to Context in "+function(e){return e.client?"client":e.server?"server":"workflow"}(i)+". You can only set to Context in workflow.");const s=i.workflow.context();if(!s)throw new Error("can not set to workflow context as context is undefined");k(s,e.value,n);break;case o:if(!e.value)break;k(a.vars,e.value,n);break;case r:if(!e.value)break;a.output=a.output||{},k(a.output,e.value,n);break;case"info":if(!n)return;let c;switch(typeof n){case"number":case"string":c={category:"info",code:"NoCode",message:n.toString()};break;case"object":c={category:n.category,code:n.code,message:n.message,parameters:n.parameters,source:n.source,summary:n.summary};break;default:return}a.infoList=a.infoList||[],a.infoList.push(c);break;case"error":if(!n)return;switch(typeof n){case"number":case"string":throw new y({type:"technical",message:n.toString(),code:"NoCode",category:"error"});case"object":throw new y({type:"business"==n.type?"business":"technical",message:n.message||"no message",code:n.code||"NoCode",summary:n.summary,parameters:n.parameters,category:n.category||"error"})}}}(n.mapping,e[n.variable.value],a,i)})}static createEmptyMsg(){return{input:{},vars:{},output:{}}}}const x=async e=>{var t,r,o;const{environment:n,targetRuntimePlatfrom:a}=(new _).resolveRuntime(e),{dsManager:i}=a.privateOps.getDb();if(!i)throw new Error("Database session could not be established.");const{trxQueue:s}=a.privateOps.getTransactionQueue(),c=e.props;if(!c.id)throw new Error("Entity model not found. Model ID: "+c.id);const l=await e.model.retriever(c.id);if(!l)throw new Error("Entity model not found. Model ID: "+c.id);if(l.type!=m.Mc)throw new Error("Model was not "+m.Mc+"model: "+l.modelID);const u=JSON.parse(l.modelBody),f=null===(t=u.persistency)||void 0===t?void 0:t.collectionName;if(!f)throw new Error("Collection name not found.");const d=null===(r=u.persistency)||void 0===r?void 0:r.queries.find(e=>e.id==c.queryId);if(!d)throw new Error("Query not found. Query ID: "+c.queryId);const g=d.type,y=E.createEmptyMsg();let v;y.input=E.mapInput(d.store.input,e.props.mapping.inParamMapping,e.msg,n);try{switch(g){case"SELECT":{let t;const r=function(e,t,r){const o=e=>e&&"object"==typeof e&&!Array.isArray(e)&&"type"in e&&"value"in e,n=["$in","$nin"],a=(e,i)=>{if(Array.isArray(e))return e.map(e=>a(e));if("object"==typeof e&&null!==e){const i={};for(const s in e){const c=e[s];if("$regex"===s&&"string"==typeof c){const e=/\{\s*"type"\s*:\s*"([^"]+)"\s*,\s*"value"\s*:\s*"([^"]+)"\s*\}/g;i[s]=c.replace(e,(e,o,n)=>{const a=p({type:o,value:n},t,r);return"string"==typeof a?a:JSON.stringify(a)})}else if(Array.isArray(c)&&n.includes(s)){const e=[];for(const n of c)if(o(n)){const o=p(n,t,r);Array.isArray(o)?e.push(...o):e.push(o)}else e.push(a(n));i[s]=e}else if(o(c)){const e=p(c,t,r);i[s]=e}else i[s]=a(c,s)}return i}return e};return a(e)}(d.filter,y,n);if(e.flow.logger.log({level:"log",logCode:"DB-L01",message:`Filter: ${JSON.stringify(r)}`}),d.fields.length>0){let o,a;o=d.limit&&p(d.limit,y,n),a=d.skip&&p(d.skip,y,n),d.isMultipleResult||(o=1,a=0);const s=function(e){const t=[];e.filter&&Object.keys(e.filter).length>0&&t.push({$match:e.filter});const r=e.fields.filter(e=>"project"===e.type),o=e.fields.filter(e=>"group"===e.type);if(r.length>0&&0===o.length){const e={$project:{}};for(const t of r)e.$project[t.output]=`$${t.attribute}`;t.push(e)}if(o.length>0){const e={$group:{_id:{}}};if(r.length>0)for(const t of r)e.$group._id[t.output]=`$${t.attribute}`;else e.$group._id={_id:null};for(const t of o)t.operator&&(e.$group[t.output]={[`$${t.operator}`]:`$${t.attribute}`});t.push(e)}if(e.limit){const r={$limit:e.limit};t.push(r)}if(e.skip){const r={$skip:e.skip};t.push(r)}return t}({...d,filter:r,limit:o,skip:a});if(0===s.length){e.flow.logger.log({level:"warning",logCode:"DB-L02",message:`No pipeline stages found for query: ${JSON.stringify(d)}`});break}e.flow.logger.log({level:"log",logCode:"DB-L01",message:`Pipeline: ${JSON.stringify(s)}`}),t=await i.Aggregate(f,s,{})}else{if(!r)throw new Error(`Filter is not valid. filter: ${r}`);t=d.isMultipleResult?await i.List(f,r):await i.Get(f,r)}v=t;break}case"INSERT":{const e=y.input.object;if("object"!=typeof e)throw new Error("Input is not valid. Type of input must be an object!");if(null===e)throw new Error("Object can not be null!");const t="_id"in e?Object.fromEntries(Object.entries(e).filter(([e])=>"_id"!==e)):e,r=w.createSecureUID();t._id=r,await i.Insert(f,t,{trxQueue:s}),v=r;break}case"DELETE":{const t=y.input._id;if(!t)throw new Error(`_id is not valid. _id: ${t}`);e.flow.logger.log({level:"log",logCode:"DB-L01",message:`${g} ID: ${t}`}),await i.DeleteOne(f,{_id:t},{trxQueue:s}),v={};break}case"UPDATE":{const e=y.input.object;if(!e||"object"!=typeof e)throw new Error("Input is not valid. Type of input must be an object!");if(null===e)throw new Error("Object can not be null!");if(Array.isArray(e))throw new Error("Multiple objects found in result. Update supports only a single object.");if(!("_id"in e))throw new Error("Object is not valid. _id field is not present in the object!");await i.Update(f,{_id:e._id},e,{trxQueue:s}),v={};break}default:throw new Error(`The query type is not as expected. Query type: ${g}`)}void 0!==v&&(y.output.response=v,E.mapOutput(y.output,null===(o=e.props.mapping)||void 0===o?void 0:o.outParamMapping,e.msg,n),"SELECT"===g?e.flow.logger.log({level:"log",logCode:"DB-L02",message:`${g} query executed successfully.`}):e.flow.logger.log({level:"log",logCode:"DB-L02",message:`${g} query executed successfully. Query response: ${JSON.stringify(v)}`}))}catch(t){throw e.flow.logger.log({level:"error",logCode:"DB-E01",message:`An error occured while running ${g} query: ${t}`}),new Error(`An error occured while running ${g} query: ${t}`)}e.flow.next()}})(),__webpack_exports__})());